---
layout: default
title: OAuth2 as an Authentication service
nav_order: 7
---

# OAuth2 as an Authentication service

{: .no_toc }

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

## What is OAuth2

OAuth2 is a protocol that allows users to grant third-party access to their resources without sharing their passwords. It enables users to authorize client applications to access their resources, such as their data stored on a server.

OAuth2 is often used to allow users to sign in to third-party applications using their existing login credentials (e.g. their Google or Facebook login). This allows users to access multiple applications without having to remember multiple sets of login credentials.

OAuth2 consists of several different roles, including the resource owner (the user), the client (the application requesting access), and the resource server (the server hosting the user's resources). It also involves the use of access tokens, which are issued by an authorization server and used to authenticate requests for access to the user's resources.

Overall, OAuth2 is a useful tool for enabling secure, authorized access to resources without requiring users to share their passwords.

## Authorization Flow

![Authorization Code With Secret](/docs/images/Web%20Server%202600-src-cloudsundial-com:salesforce-oauth-flows.png)

In browser, we handle a button/link with href that handles redirect function.
```html
<a href="/auth/google/login" style="text-transform:none">
```
---
```
mux.HandleFunc("/auth/google/login", oauthGoogleLogin)

func oauthGoogleLogin(w http.ResponseWriter, r *http.Request) {

	var expiration = time.Now().Add(365 * 24 * time.Hour)

	b := make([]byte, 16)
	rand.Read(b)
	state := base64.URLEncoding.EncodeToString(b)
	cookie := http.Cookie{Name: "oauthstate", Value: state, Expires: expiration}
	http.SetCookie(w, &cookie)

	u := googleOauthConfig.AuthCodeURL(state)
	http.Redirect(w, r, u, http.StatusTemporaryRedirect)
}
```
`oauthGoogleLogin` function is implementing the first part of the OAuth 2.0 authorization flow for logging in with Google. The function does the following:

1. Creates a new state cookie with a randomly generated value and an expiration date one year from now.

2. Generates the URL for the Google login page by calling AuthCodeURL on the googleOauthConfig object, passing in the state value as a parameter.
   
3. Redirects the user's browser to the login page by calling http.Redirect.
   
The purpose of the state cookie is to protect against cross-site request forgery (CSRF) attacks. It is a random string that is generated by the server and sent to the client as a cookie. When the user's browser is redirected to the login page, the state value is included as a query parameter in the URL. After the user logs in, the Google authorization server sends the user's browser back to the server's redirect URL with the state value included as a query parameter. The server can then compare the state value received from the authorization server to the one stored in the state cookie to verify that the request is legitimate and not a forgery.

---

```
func oauthGoogleCallback(w http.ResponseWriter, r *http.Request) {
	// Read oauthState from Cookie
	oauthState, _ := r.Cookie("oauthstate")

	if r.FormValue("state") != oauthState.Value {
		log.Println("invalid oauth google state")
		http.Redirect(w, r, "/", http.StatusTemporaryRedirect)
		return
	}

	data, err := getUserDataFromGoogle(r.FormValue("code"))
	if err != nil {
		log.Println(err.Error())
		http.Redirect(w, r, "/", http.StatusTemporaryRedirect)
		return
	}

	// GetOrCreate User in your db.
	// Redirect or response with a token.
	// More code .....
	fmt.Fprintf(w, "UserInfo: %s\n", data)
} 
```

---

```
// Scopes: OAuth 2.0 scopes provide a way to limit the amount of access that is granted to an access token.
var googleOauthConfig = &oauth2.Config{
	RedirectURL:  "http://localhost:8000/auth/google/callback",
	ClientID:     "use-your-own",
	ClientSecret: "use-your-own",
	Scopes:       []string{"https://www.googleapis.com/auth/userinfo.email", "https://www.googleapis.com/auth/userinfo.profile"},
	Endpoint:     google.Endpoint,
}
```
---

After all the process finishes google redirect to `/auth/google/callback`

```
mux.HandleFunc("/auth/google/callback", oauthGoogleCallback)

func oauthGoogleCallback(w http.ResponseWriter, r *http.Request) {
	// Read oauthState from Cookie
	oauthState, _ := r.Cookie("oauthstate")

	if r.FormValue("state") != oauthState.Value {
		log.Println("invalid oauth google state")
		http.Redirect(w, r, "/", http.StatusTemporaryRedirect)
		return
	}

    token, err := googleOauthConfig.Exchange(context.Background(), r.FormValue("code"))
	if err != nil {
		return nil, fmt.Errorf("code exchange wrong: %s", err.Error())
	}
	response, err := http.Get(oauthGoogleUrlAPI + token.AccessToken)
	if err != nil {
		return nil, fmt.Errorf("failed getting user info: %s", err.Error())
	}
	defer response.Body.Close()
	contents, err := ioutil.ReadAll(response.Body)
    if err != nil {
		log.Println(err.Error())
		http.Redirect(w, r, "/", http.StatusTemporaryRedirect)
		return
	}	
	fmt.Fprintf(w, "UserInfo: %s\n", contents)
}
```
`oauthGoogleCallback` function is implementing the second part of the OAuth 2.0 authorization flow for logging in with Google. The function does the following:

1. Reads the oauthstate cookie from the request.
2. Checks that the state query parameter in the request URL matches the value of the oauthstate cookie. If they do not match, the function redirects the user's browser back to the home page and returns.
3. Calls the Exchange method on the googleOauthConfig object, passing in the code query parameter from the request URL as a parameter. This exchanges the authorization code for an access token.
4. Makes an HTTP GET request to the Google API with the access token as an authorization header.
Reads the response from the API and stores it in the contents variable.
1. Writes the contents of the API response to the response writer.

Purpose of this function is to handle the redirect from the Google authorization server after the user has logged in and granted permission. 

The function exchanges the authorization code for an access token, makes a request to the Google API with the access token to get the user's profile information.


[source](https://github.com/douglasmakey/oauth2-example)

